<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="description" content="My comments on math, numerical computing, and the tools used for computational science.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ian's Blog | Ian's Blog</title>

    
            <link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

    
            <link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">

      <link rel="canonical" href="http://insertinterestingnamehere.github.io/index.html">




    
        <!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->

    


    

        <link rel="prefetch" href="posts/basic-examples.html" type="text/html">


</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://insertinterestingnamehere.github.io/">

                <span id="blog-title">Ian's Blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>

            <ul class="nav navbar-nav navbar-right">
                
                
                    
                
            </ul>
        </div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav>

<!-- End of Menubar -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<div class="postindex">
    <article class="h-entry post-text">
    <header>
        <h1 class="p-name entry-title"><a href="posts/basic-examples.html" class="u-url">Basic Examples</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Ian Henriksen</span></p>
            <p class="dateline"><a href="posts/basic-examples.html" rel="bookmark"><time class="published dt-published" datetime="2015-06-08T10:26:00-06:00" title="2015-06-08 10:26">2015-06-08 10:26</time></a></p>
                <p class="commentline">
        
</p>
<div class="g-commentcount" data-href="/posts/basic-examples.html"></div>
<script src="https://apis.google.com/js/plusone.js"></script>


        </div>
    </header>
    <div class="e-content entry-content">
    <div>
<p>The past two weeks have been an adventure.
I've spent a great deal of time working to find a reasonable way to refactor the DyND Python bindings in a way that works well for exporting all the existing Python/C++ compatibility functions at both the Cython and C++ level.
After some discussion with my mentors, Mark and Irwin, I was able to get to what seems to be a workable model.
I'm in the process of doing all the needed refactoring to put those changes into place.
I'll post more details once I've finished the main structural changes to the Python bindings.</p>
<p>For now, I'd like to show a few basic examples of how to use DyND.
The examples here showcase some of the similarities with NumPy as well as the simplicity of the notation.
I haven't done any sort of performance comparison.
The implimentations I've put together here using DyND work using array slicing and array arithmetic, so the cost of dispatching for types is still present in each array arithmetic operation.
More efficient implementations could be created by coding a version of an algorithm that operates directly on the buffers of the arrays given.
More efficient and general implementations could be constructed using DyND's arrfuncs, which are similar in purpose to NumPy's gufuncs, but I'm still figuring out how they work, so I'll have to include examples of how to do that later on.</p>
<p>For my examples here, I'll focus on three different algorithms for polynomial evaluation.
For simplicity, I'll assume the coefficients are passed as an array and the parameter value at which to evaluate the polynomial(s) is a single double precision value.
Each algorithm will be presented in Python (using NumPy), in C++ (using DyND), and in Fortran.
Each file will either compile to an executable (C++ and Fortran) or be run-able as a script (Python).
The NumPy and DyND implementations will be roughly equivalent and will both operate on arbitrary dimensional arrays, operating on the first axis of the array and broadcasting along all trailing axes.
The NumPy and DyND versions will also work with relatively generic types (either floating point or complex).
The Fortran versions will apply only to 1-dimensional arrays and will only operate on arrays of double precision real coefficients.</p>
<p>Regarding the notation, I found it very easy to use DyND's <code>irange</code> object with its overloaded comparison operators very easy to use.
It is used to specify ranges of indices over which to slice an array.
Since multiple arguments are not allowed for the indexing operator in C++, the call operator is used for array slicing.</p>
<p>For compiling these examples on Windows, I used gfortran and a recent development version (3.7.0 dev) of clang compiled with mingw-w64.
The exact compiler calls replacing "(algorithm)" with the name of each particular algorithm were</p>
<pre class="code literal-block">clang++ -fPIC -O3 -I<span class="s2">"c:/Program Files (x86)/libdynd/include"</span> -std<span class="o">=</span>c++11 <span class="o">(</span>algorithm<span class="o">)</span>.cpp -L<span class="s2">"c:/Program Files (x86)/libdynd/lib/static"</span> -ldynd -o <span class="o">(</span>algorithm<span class="o">)</span>.exe
gfortran -fPIC -O3 <span class="o">(</span>algorithm<span class="o">)</span>.f90 -o <span class="o">(</span>algorithm<span class="o">)</span>_f.exe
</pre>


<p>The corresponding compiler calls on BSD, Linux, or other Unix-based operating systems are similar with the <code>-I</code> and <code>-L</code> directories being modified (or ommitted) according to the location of the DyND headers and library.
The same set of flags should work with recent versions of clang++ and g++.</p>
<h3>Horner's Algorithm</h3>
<p>Horner's algorithm is the standard algorithm for evaluating a power basis polynomial at a parameter value, given the coefficients for the polynomial.
Here the coefficients are assumed to be given in order from highest to lowest degree.</p>
<pre class="code literal-block"><span class="c"># Python</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">horner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s">'d'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">horner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">.</span><span class="mi">3333</span><span class="p">))</span>
</pre>


<pre class="code literal-block"><span class="c1">// C++</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;dynd/array.hpp&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">dynd</span><span class="p">;</span>

<span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">horner</span><span class="p">(</span><span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">t</span><span class="p">){</span>
    <span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">get_dim_size</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);}</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">horner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">.3333</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</pre>


<pre class="code literal-block"><span class="c">! Fortran</span>
<span class="k">module </span><span class="n">hornermodule</span>
<span class="k">implicit none</span>
<span class="k">contains</span>
<span class="kt">double precision </span><span class="k">function </span><span class="n">horner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">(:)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t</span>
    <span class="kt">double precision </span><span class="n">v</span>
    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">n</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">    </span><span class="n">horner</span> <span class="o">=</span> <span class="n">v</span>
<span class="k">end function </span><span class="n">horner</span>
<span class="k">end module </span><span class="n">hornermodule</span>

<span class="k">program </span><span class="n">main</span>
    <span class="k">use </span><span class="n">hornermodule</span>
    <span class="kt">double precision </span><span class="n">a</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="o">/</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="n">horner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">.</span><span class="mi">3333</span><span class="n">D0</span><span class="p">)</span>
<span class="k">end program </span><span class="n">main</span>
</pre>


<h3>Decasteljau's Algorithm</h3>
<p>Decasteljau's Algorithm is used to evaluate polynomials in Bernstein form.
It is also often used to evaluate Bézier curves.</p>
<pre class="code literal-block"><span class="c"># Python</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">decasteljau</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">'d'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">decasteljau</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">.</span><span class="mi">25</span><span class="p">))</span>
</pre>


<pre class="code literal-block"><span class="c1">// C++</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;dynd/array.hpp&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">dynd</span><span class="p">;</span>

<span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">decasteljau</span><span class="p">(</span><span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">t</span><span class="p">){</span>
    <span class="kt">size_t</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">get_dim_size</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">(</span><span class="n">irange</span><span class="p">()</span><span class="o">&lt;</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">irange</span><span class="p">());}</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">decasteljau</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">.25</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</pre>


<p>In the Fortran version of this algorithm, dynamic allocation within the function is needed.</p>
<pre class="code literal-block"><span class="c">! Fortran</span>
<span class="k">module </span><span class="n">decasteljaumodule</span>
<span class="k">implicit none</span>
<span class="k">contains</span>
<span class="kt">double precision </span><span class="k">function </span><span class="n">decasteljau</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">(:)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">b</span><span class="p">(:)</span>
    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">n</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">(:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">a</span><span class="p">(</span><span class="mi">2</span><span class="p">:)</span>
    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">b</span><span class="p">(:</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span><span class="p">(:</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">    </span><span class="n">decasteljau</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end function </span><span class="n">decasteljau</span>
<span class="k">end module </span><span class="n">decasteljaumodule</span>

<span class="k">program </span><span class="n">main</span>
    <span class="k">use </span><span class="n">decasteljaumodule</span>
    <span class="kt">double precision </span><span class="n">a</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="n">decasteljau</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">.</span><span class="mi">25</span><span class="n">D0</span><span class="p">)</span>
<span class="k">end program </span><span class="n">main</span>
</pre>


<h3>Clenshaw's Algorithm (Chebyshev Polynomials)</h3>
<p>Clenshaw's algorithm provides a simple recurrence for evaluating Chebyshev polynomials.
There is a similar algorithm for evaluating Legendre polynomials, but we will not demonstrate it here.
The code here is a simplified adaptation of the code </p>
<pre class="code literal-block"><span class="c"># Python</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">clenshaw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="s">'d'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">clenshaw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-.</span><span class="mi">5</span><span class="p">))</span>
</pre>


<pre class="code literal-block"><span class="c1">// C++</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;dynd/array.hpp&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">dynd</span><span class="p">;</span>

<span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">clenshaw</span><span class="p">(</span><span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">t</span><span class="p">){</span>
    <span class="kt">size_t</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">get_dim_size</span><span class="p">();</span>
    <span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">c0</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">temp</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">c0</span><span class="p">;</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">c1</span><span class="p">;</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">);}</span>
    <span class="k">return</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span><span class="p">;}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">nd</span><span class="o">::</span><span class="n">array</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">clenshaw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</pre>


<pre class="code literal-block"><span class="c">! Fortran</span>
<span class="k">module </span><span class="n">clenshawmodule</span>
<span class="k">implicit none</span>
<span class="k">contains</span>
<span class="kt">double precision </span><span class="k">function </span><span class="n">clenshaw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">(:)</span>
    <span class="kt">double precision</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t</span>
    <span class="kt">double precision </span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">temp</span>
    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">n</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">c0</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">c1</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">    </span><span class="n">clenshaw</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span>
<span class="k">end function </span><span class="n">clenshaw</span>
<span class="k">end module </span><span class="n">clenshawmodule</span>

<span class="k">program </span><span class="n">main</span>
    <span class="k">use </span><span class="n">clenshawmodule</span>
    <span class="kt">double precision </span><span class="n">a</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="o">/</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="n">clenshaw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="n">D0</span><span class="p">)</span>
<span class="k">end program </span><span class="n">main</span>
</pre>
</div>
    </div>
    </article>
    <article class="h-entry post-text">
    <header>
        <h1 class="p-name entry-title"><a href="posts/first-impressions-and-overcoming-compilation-errors.html" class="u-url">First Impressions And Overcoming Compilation Errors</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Ian Henriksen</span></p>
            <p class="dateline"><a href="posts/first-impressions-and-overcoming-compilation-errors.html" rel="bookmark"><time class="published dt-published" datetime="2015-05-21T22:23:11-06:00" title="2015-05-21 22:23">2015-05-21 22:23</time></a></p>
                <p class="commentline">
        
</p>
<div class="g-commentcount" data-href="/posts/first-impressions-and-overcoming-compilation-errors.html"></div>
<script src="https://apis.google.com/js/plusone.js"></script>


        </div>
    </header>
    <div class="e-content entry-content">
    <div>
<p>Most of the past month was spent in a mad dash to finish my master's thesis.
Who knew that writing 100 pages of original research in math could take so long?
Either way, I'm finished and quite pleased with the result.
My thesis is written and I have been able to, mostly, move on to other endeavors, like starting the work on my GSOC project, the Cython API for DyND (see the <a href="https://www.google-melange.com/gsoc/project/details/google/gsoc2015/iandh/5707702298738688">brief description</a> and <a href="https://github.com/numfocus/gsoc/blob/master/2015/proposals/ian-henriksen.md">full proposal</a>).</p>
<p>I've been able to start familiarizing myself with the package a little more.
My background is primarily in using NumPy and Cython, but it has been really nice to be able to use a NumPy-like data structure in C++ without having to use the Python C API to do everything.
Stay tuned for a few nice snippets of code over the next few days.</p>
<p>Overall, I've been impressed by the amount of functionality that is already present.
A few things like allowing the use of an ellipsis in indexing or providing routines for basic linear algebra operations have yet to be implemented, but, for the most part, the library is easy to use and provides a great deal of useful functionality at both the C++ and Python levels.</p>
<p>Before beginning detailed work on my project, I was first faced with the task of getting everything working on my main development machine.
For a variety of reasons, it uses windows and needs to stay that way.
Undaunted, I ventured forth, and attempted to build libdynd and its corresponding Python bindings from source with my compiler of choice, MinGW-w64.</p>
<p>MinGW-w64 is a relatively new version of MinGW that targets 64 bit windows.
It is not as commonly used as MSVC, or gcc, so it is normal to have to fix a few compile errors when compiling large amounts of C/C++ code.
Python's support for MinGW is shaky as well, but usually things come together nicely with a little effort.</p>
<p>After several long and ugly battles with a variety of compiler errors, I was able to get it all working, though there are still some test failures that still need to be revisited.
The DyND source proved to be fairly easy to work with.
The most difficult errors I came up against came from conflicts between the environment provided by the compiler and some of the type definitions in the Python headers.
I'll document some of the useful information I picked up here.</p>
<p>For those that aren't familiar with it, the C preprocessor is an essential part of writing platform independent code.
Among other things, it lets you write specialized sections of code for pieces that are specific to a given operating system, compiler, or architecture.
For example, to write a section of code that applies only to Windows, you would write something like</p>
<pre class="code literal-block"><span class="c1">// If the environment variable indicating that you're compiling on Windows is defined</span>
<span class="cp">#ifdef _WIN32</span>
  <span class="c1">// Platform-specific code goes here.</span>
<span class="cp">#endif</span>
</pre>


<p>Similarly, if you want to differentiate between compilers,</p>
<pre class="code literal-block"><span class="cp">#ifdef _MSC_VER</span>
  <span class="c1">// Code for MSVC compiler here.</span>
<span class="cp">#elseif __GNUCC__</span>
  <span class="c1">// Code for gcc/g++ here.</span>
  <span class="c1">// Compilers that implement a GCC-like environment</span>
  <span class="c1">// (e.g. ICC on Linux, or Clang on any platform)</span>
  <span class="c1">// will also use this case.</span>
<span class="cp">#else</span>
  <span class="c1">// Code for all other compilers.</span>
<span class="cp">#endif</span>
</pre>


<p>Most of the work I did to get everything running involved modifying blocks that look like this to get the right combination.
Frequently, code is defined to do one thing on windows (with the assumption that only MSVC will be used) and another on Linux, even though, for MinGW, many of the Linux configurations are needed for the compiler.
In the past, I've found myself continually searching for what the right ways to detect a given compiler, operating system, or architecture, but it turns out there is a fairly complete <a href="http://sourceforge.net/p/predef/wiki/Home/">list</a> where the variables indicating most common compilers and operating systems are shown.</p>
<p>The build system CMake also provides ways of detecting things like that.
A few useful examples:</p>
<pre class="code literal-block"><span class="nb">if</span><span class="p">(</span><span class="s">WIN32</span><span class="p">)</span>
    <span class="c"># You're compiling for Windows</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s2">"${CMAKE_SIZEOF_VOID_P}"</span> <span class="s">EQUAL</span> <span class="s2">"8"</span><span class="p">)</span>
    <span class="c"># You're compiling for a 64-bit machine.</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s2">"${CMAKE_CXX_COMPILER_ID}"</span> <span class="s">STREQUAL</span> <span class="s2">"GNU"</span><span class="p">)</span>
    <span class="c"># You're compiling for gcc.</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s2">"${CMAKE_CXX_COMPILER_ID}"</span> <span class="s">STREQUAL</span> <span class="s2">"MSVC"</span><span class="p">)</span>
    <span class="c"># You're compiling for MSVC.</span>
<span class="nb">endif</span><span class="p">()</span>
</pre>


<p>Now, on to some of the tricker bugs.
Hopefully including them here can help others resolve similar errors later on.</p>
<p>It is a less commonly known fact that the order of compiler flags matters if you are linking against different libraries.
(An aside, for those that are new to the command line flags for gcc, there is a nice introduction <a href="http://www.rapidtables.com/code/linux/gcc.htm">here</a>)
As it turns out, the order of the flags for gcc also matters in some less than intuitive cases.
After compiling libdynd, in order to compile a basic working example I had to do <code>g++ -std=c++11 -fPIC declare_array.cpp -ldynd</code> rather than <code>g++ -std=c++11 -ldynd -fPIC declare_array.cpp</code>.
Running the latter would give a series of linker errors like</p>
<pre class="code literal-block">undefined reference to 'dynd::detail::memory_block_free(dynd::memory_block_data*)'
</pre>


<p><code>clang++</code> accepted both orderings of the flags without complaint.</p>
<p>I also ran into <a href="http://bugs.python.org/issue11566">this bug in Python</a> where there is an unfortunate name collision between a preprocessor macro defined in Python and a function in the c++11 standard library.
The name collision results in the unusual error</p>
<pre class="code literal-block">error: '::hypot' has not been declared
</pre>


<p>coming from the c++11 standard library headers.
It appears that a <a href="http://stackoverflow.com/a/12124708/1935144">generally known solution</a> is to include the standard library math header before <code>Python.h</code>.
This wasn't a particularly favorable resolution to the issue since the Python headers are supposed to come first, so I opted to define the symbol <code>_hypot</code> back again to be <code>hypot</code> via a command line argument, i.e. adding the flag <code>-D_hypot=hypot</code>.
It worked like a charm.</p>
<p>The last batch of errors came from my forgetting to define the macro <code>MS_WIN64</code> on the command line when working with the Python headers.
That macro is used internally to indicate that a Python extension module is being compiled for a 64 bit Python installation on Windows.
In this case, forgetting to include that flag resulted in the error</p>
<pre class="code literal-block">undefined reference to '__imp_Py_InitModule4'
</pre>


<p>at link time.</p>
<p>In trying to fix the various errors from not defining <code>MS_WIN64</code>, I also came across errors where <code>np_intp</code> (a typedef of <code>Py_intptr_t</code>) was not the correct size, resulting in the error</p>
<pre class="code literal-block"><span class="n">error</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">convert</span> <span class="s1">'long long int*'</span> <span class="n">to</span> <span class="s1">'npy_intp* {aka int*}'</span> <span class="k">in</span> <span class="n">argument</span> <span class="n">passing</span>
</pre>


<p>The fundamental problem is that the logic in the Python headers fails to detect the proper size of a pointer without some sort of extra compile switch.
Passing the command-line argument <code>-DMS_WIN64</code> to the compiler when compiling Python extensions was sufficient to address the issue.</p>
<p>With most of the compilation-related issues behind me, I am now continuing my work in putting together several simple examples of how DyND can be used to perform NumPy-like operations at the C++ level.
I'll be posting a few of them soon.</p>
<h4>Update (6/8/2015)</h4>
<p>In fixing a few more compilation errors, I found another <a href="http://nadeausoftware.com/articles/2012/01/c_c_tip_how_use_compiler_predefined_macros_detect_operating_system">useful table</a> of C preprocessor macros that can be used to identify a given operating system.
Among other things, it mentions that any BSD operating system can be detected using something like</p>
<pre class="code literal-block"><span class="cp">#ifdef __unix__</span>
<span class="cp">#include &lt;sys/param.h&gt;</span>
<span class="cp">#ifdef BSD</span>
<span class="c1">// BSD stuff</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</pre>


<p>The <a href="https://gcc.gnu.org/onlinedocs/cpp/Standard-Predefined-Macros.html#Standard-Predefined-Macros">table in the GCC manual</a> also lists which preprocessor macros are required for a compiler implementing the relevant language standards.</p>
</div>
    </div>
    </article>
</div>



        





        </div>
        <!--End of body content-->

        <footer>
            Contents © 2015         <a href="mailto:insertinterestingnamehere@gmail.com">Ian Henriksen</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
    </div>
</div>


            <script src="assets/js/all-nocdn.js"></script>
    

    <script>$('a.image-reference:not(.islink)').colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    <!-- fancy dates -->
    <script>
    moment.locale("");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script>
    <!-- end fancy dates -->
    


</body>
</html>
